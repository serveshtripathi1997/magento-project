pipeline {
    agent any

    environment {
        PROJECT_DIR = "/home/serveshtripathi/magento-project"
        AUTH_FILE   = "${PROJECT_DIR}/src/auth/auth.json"
        MAGENTO_DIR = "/var/www/html"
    }

    stages {

        stage('Checkout') {
            steps {
                echo "===== CHECKING OUT REPO ====="
                checkout scm
            }
        }

        stage('Start Docker Services') {
            steps {
                echo "===== STARTING DOCKER SERVICES ====="
                dir("${PROJECT_DIR}") {
                    sh "docker compose down || true"
                    sh "docker compose up -d"
                }
                sh "sleep 10"
            }
        }

        stage('Prepare Composer Auth') {
            steps {
                echo "===== PREPARING COMPOSER AUTH ====="

                // Create auth.json inside src if missing
                sh """
                    mkdir -p ${PROJECT_DIR}/src/auth
                    chmod 777 ${PROJECT_DIR}/src/auth
                """

                writeFile file: "${PROJECT_DIR}/src/auth/auth.json", text: """
                {
                    "http-basic": {
                        "repo.magento.com": {
                            "username": "${MAGENTO_AUTH_USR}",
                            "password": "${MAGENTO_AUTH_PSW}"
                        }
                    }
                }
                """

                echo "Auth file created at host ‚Üí copying into PHP container"

                sh """
                    docker cp ${AUTH_FILE} magento-php:${MAGENTO_DIR}/auth.json
                """
            }
        }

        stage('Clean Magento Directory') {
            steps {
                echo "===== CLEANING MAGENTO DIRECTORY ====="

                sh """
                    docker exec magento-php bash -lc "rm -rf ${MAGENTO_DIR}/*"
                """
            }
        }

        stage('Install Magento Source Code') {
            steps {
                echo "===== INSTALLING MAGENTO CODE (composer create-project) ====="

                sh """
                    docker exec magento-php bash -lc '
                        composer create-project \
                        --repository-url=https://repo.magento.com/ \
                        magento/project-community-edition=2.4.8-p3 \
                        ${MAGENTO_DIR}
                    '
                """
            }
        }

        stage('Magento Installation') {
            steps {
                echo "===== INSTALLING MAGENTO SYSTEM ====="

                sh """
                    docker exec magento-php bash -lc '
                        php ${MAGENTO_DIR}/bin/magento setup:install \
                        --base-url="http://localhost:8090/" \
                        --db-host="magento-db" \
                        --db-name="magento" \
                        --db-user="root" \
                        --db-password="root123" \
                        --admin-firstname="Servesh" \
                        --admin-lastname="Tripathi" \
                        --admin-email="admin@example.com" \
                        --admin-user="admin" \
                        --admin-password="Admin@1234" \
                        --backend-frontname="adminpanel" \
                        --search-engine="opensearch" \
                        --opensearch-host="magento-opensearch" \
                        --opensearch-port=9200 \
                        --amqp-host="magento-rabbitmq" \
                        --amqp-port=5672 \
                        --amqp-user="magento" \
                        --amqp-password="magento123" \
                        --cache-backend="redis" \
                        --cache-backend-redis-server="magento-valkey" \
                        --cache-backend-redis-port=6379 \
                        --page-cache-redis-server="magento-valkey" \
                        --page-cache-redis-port=6379 \
                        --session-save=redis \
                        --session-save-redis-host="magento-valkey" \
                        --session-save-redis-port=6379 \
                        --use-rewrites=1
                    '
                """
            }
        }

        stage('Post-Installation Commands') {
            steps {
                echo "===== FINALIZING MAGENTO ====="

                sh """
                    docker exec magento-php bash -lc '
                        php ${MAGENTO_DIR}/bin/magento deploy:mode:set developer
                        php ${MAGENTO_DIR}/bin/magento cache:flush
                        chmod -R 777 ${MAGENTO_DIR}
                    '
                """
            }
        }
    }

    post {
        success {
            echo "üéâ Build & Install Completed Successfully!"
        }
        failure {
            echo "‚ùå Build Failed ‚Äî Check Console Output"
        }
    }
}
