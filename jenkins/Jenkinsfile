pipeline {
    agent any

    environment {
        MAGENTO_AUTH = credentials('magento-marketplace-auth')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Cleanup') {
            steps {
                sh '''
                echo "===== CLEANING UP DOCKER ENVIRONMENT ====="
                docker stop $(docker ps -aq) || true
                docker rm -f $(docker ps -aq) || true
                docker network prune -f || true
                docker volume prune -f || true
                docker image prune -af || true
                echo "===== CLEANUP COMPLETE ====="
                '''
            }
        }

        stage('Start Docker Services') {
            steps {
                sh '''
                echo "===== STARTING DOCKER SERVICES ====="
                docker compose up -d --build
                echo "===== DOCKER SERVICES RUNNING ====="
                '''
            }
        }

        stage('Composer Auth Setup') {
            steps {
                sh '''
                echo "===== GENERATING COMPOSER AUTH FILE ====="
                
                mkdir -p src
                mkdir -p src/auth

cat > src/auth/auth.json << EOF
{
  "http-basic": {
    "repo.magento.com": {
      "username": "${MAGENTO_AUTH_USR}",
      "password": "${MAGENTO_AUTH_PSW}"
    }
  }
}
EOF

                chmod 600 src/auth/auth.json
                echo "===== AUTH FILE CREATED ====="
                '''
            }
        }

        stage('Install Magento Code (Composer)') {
            steps {
                sh '''
                echo "===== INSTALLING MAGENTO VIA COMPOSER IN PHP CONTAINER ====="

                docker exec magento-php bash -lc "
                    mkdir -p /var/www/html/src/auth
                    cp /var/lib/jenkins/workspace/magento/src/auth/auth.json /var/www/html/auth.json

                    composer create-project \
                        --repository-url=https://repo.magento.com/ \
                        magento/project-community-edition=2.4.8-p3 /var/www/html
                "

                echo "===== MAGENTO CODE INSTALLED ====="
                '''
            }
        }

        stage('Install Magento System (PHP Container)') {
            steps {
                sh '''
                echo "===== RUNNING MAGENTO SETUP:INSTALL ====="

                docker exec magento-php bash -lc "
                php bin/magento setup:install \
                    --base-url=http://localhost:8090 \
                    --db-host=mariadb \
                    --db-name=magento \
                    --db-user=root \
                    --db-password=root123 \
                    --backend-frontname=admin \
                    --search-engine=opensearch \
                    --opensearch-host=opensearch \
                    --opensearch-port=9200 \
                    --amqp-host=rabbitmq \
                    --amqp-user=magento \
                    --amqp-password=magento123
                "

                echo "===== MAGENTO INSTALLED SUCCESSFULLY ====="
                '''
            }
        }

        stage('Magento Post-Install Tasks') {
            steps {
                sh '''
                echo "===== MAGENTO POST-INSTALL TASKS ====="

                docker exec magento-php php bin/magento cache:flush
                docker exec magento-php php bin/magento cache:clean

                docker exec magento-php php bin/magento setup:di:compile
                docker exec magento-php php bin/magento setup:static-content:deploy -f

                echo "===== POST-INSTALL TASKS COMPLETE ====="
                '''
            }
        }
    }

    post {
        success {
            echo "ðŸŽ‰ Magento Deployment Completed Successfully!"
            echo "Frontend:  http://localhost:8090"
            echo "Admin URL: http://localhost:8090/admin"
        }
        failure {
            echo "âŒ Build Failed â€” check Jenkins console output."
        }
    }
}
